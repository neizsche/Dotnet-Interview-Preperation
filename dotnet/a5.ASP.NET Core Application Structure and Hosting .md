# ASP.NET Core Application Structure and Hosting - Complete Guide

## Program.cs and Startup.cs Evolution

### Traditional Startup.cs Approach (.NET Core 1.0-3.1)
```csharp
// Startup.cs
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddControllers();
        services.AddDbContext<AppDbContext>();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }

        app.UseRouting();
        app.UseEndpoints(endpoints => endpoints.MapControllers());
    }
}

// Program.cs
public class Program
{
    public static void Main(string[] args) => 
        CreateHostBuilder(args).Build().Run();

    public static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureWebHostDefaults(webBuilder =>
            {
                webBuilder.UseStartup<Startup>();
            });
}
```

### Minimal API Approach (.NET 6+)
```csharp
// Program.cs - Single file approach
var builder = WebApplication.CreateBuilder(args);

// ConfigureServices equivalent
builder.Services.AddControllers();
builder.Services.AddDbContext<AppDbContext>();

var app = builder.Build();

// Configure equivalent
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}

app.UseRouting();
app.MapControllers();
app.Run();
```

## Middleware Pipeline and Order

### Critical Middleware Order
```csharp
var app = builder.Build();

// CORRECT ORDER:
app.UseExceptionHandler("/error"); // 1. Global exceptions
app.UseHttpsRedirection();         // 2. HTTPS enforcement
app.UseStaticFiles();              // 3. Static files
app.UseRouting();                  // 4. Route matching
app.UseAuthentication();           // 5. Authentication
app.UseAuthorization();            // 6. Authorization
app.UseCors("AllowAll");           // 7. CORS
app.UseEndpoints(endpoints =>      // 8. Endpoint routing
{
    endpoints.MapControllers();
});
```

### Common Middleware Patterns
```csharp
// Custom middleware
app.Use(async (context, next) =>
{
    // Pre-processing
    var start = DateTime.UtcNow;
    
    await next(); // Call next middleware
    
    // Post-processing
    var duration = DateTime.UtcNow - start;
    context.Response.Headers["X-Processing-Time"] = duration.ToString();
});

// Conditional middleware
if (app.Environment.IsProduction())
{
    app.UseHsts(); // HTTP Strict Transport Security
}
```

## Host Configuration and Environment Settings

### Environment-based Configuration
```csharp
var builder = WebApplication.CreateBuilder(args);

// Environment-specific configuration
builder.Configuration
    .AddJsonFile("appsettings.json", optional: false)
    .AddJsonFile($"appsettings.{builder.Environment.EnvironmentName}.json", optional: true)
    .AddEnvironmentVariables();

// Environment-specific services
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddTransient<IDatabaseService, MockDatabaseService>();
}
else
{
    builder.Services.AddTransient<IDatabaseService, ProductionDatabaseService>();
}
```

### Host Configuration Settings
```json
// appsettings.json
{
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://localhost:5000"
      },
      "Https": {
        "Url": "https://localhost:5001"
      }
    }
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

## Kestrel vs IIS Hosting

### Comparison Table

| Aspect | Kestrel | IIS |
|--------|---------|-----|
| **Type** | Cross-platform web server | Windows web server |
| **Performance** | Faster, lightweight | Slower, more features |
| **Platform** | Cross-platform | Windows only |
| **Protocols** | HTTP/1.x, HTTP/2, HTTP/3 | HTTP/1.x, HTTP/2 |
| **SSL** | Built-in support | Requires configuration |
| **Process Model** | In-process by default | In-process/out-of-process |

### Kestrel Configuration
```csharp
// Configure Kestrel programmatically
builder.WebHost.ConfigureKestrel(serverOptions =>
{
    serverOptions.Limits.MaxConcurrentConnections = 100;
    serverOptions.Limits.MaxRequestBodySize = 10 * 1024;
    serverOptions.Listen(IPAddress.Loopback, 5000);
    serverOptions.Listen(IPAddress.Loopback, 5001, 
        listenOptions => listenOptions.UseHttps());
});
```

### IIS Integration
```xml
<!-- web.config for IIS -->
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="aspNetCore" path="*" verb="*" 
           modules="AspNetCoreModuleV2" resourceType="Unspecified" />
    </handlers>
    <aspNetCore processPath="dotnet" 
                arguments=".\MyApp.dll" 
                stdoutLogEnabled="false" 
                stdoutLogFile=".\logs\stdout" 
                hostingModel="inprocess" />
  </system.webServer>
</configuration>
```

## Controllers and Routing

### ControllerBase vs Controller
```csharp
// Use ControllerBase for APIs (no view support)
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetProducts() => Ok(new List<Product>());
}

// Use Controller for MVC (with views)
public class HomeController : Controller
{
    public IActionResult Index() => View();
}
```

### Attribute Routing Deep Dive
```csharp
[ApiController]
[Route("api/[controller]")] // "api/products"
public class ProductsController : ControllerBase
{
    // GET api/products/5
    [HttpGet("{id:int}")]
    public IActionResult GetById(int id) => Ok(new Product(id));
    
    // GET api/products/category/electronics
    [HttpGet("category/{category:alpha}")]
    public IActionResult GetByCategory(string category) => Ok();
    
    // POST api/products
    [HttpPost]
    public IActionResult Create([FromBody] Product product) => Created();
    
    // Custom route with constraints
    [HttpGet("search/{name:minlength(3)}/{category?}")]
    public IActionResult Search(string name, string category = "all") => Ok();
}
```

### Route Constraints and Custom Constraints
```csharp
// Built-in constraints
[HttpGet("{id:int:min(1)}")] // int, min value 1
[HttpGet("{name:alpha:minlength(2)}")] // alphabetic, min length 2
[HttpGet("{date:datetime}")] // valid datetime
[HttpGet("{email:regex(^\\w+@\\w+\\.\\w+$)}")] // regex pattern

// Custom constraint
public class ValidProductCategoryConstraint : IRouteConstraint
{
    private readonly string[] _validCategories = { "electronics", "books", "clothing" };
    
    public bool Match(HttpContext httpContext, IRouter route, string routeKey, 
        RouteValueDictionary values, RouteDirection routeDirection)
    {
        return values.TryGetValue(routeKey, out var value) && 
               _validCategories.Contains(value?.ToString().ToLower());
    }
}

// Register and use custom constraint
[HttpGet("category/{category:validCategory}")]
```

## Action Results and Response Types

### IActionResult vs ActionResult<T>
```csharp
public class ProductsController : ControllerBase
{
    // IActionResult - flexible return types
    [HttpGet("{id}")]
    public IActionResult GetProduct(int id)
    {
        var product = _repository.GetProduct(id);
        return product != null ? Ok(product) : NotFound();
    }
    
    // ActionResult<T> - strongly typed
    [HttpGet("typed/{id}")]
    public ActionResult<Product> GetProductTyped(int id)
    {
        var product = _repository.GetProduct(id);
        return product ?? NotFound();
    }
    
    // Specific result types
    public IActionResult VariousResults()
    {
        return Ok(new { message = "Success" });           // 200
        return Created("/api/products/1", newProduct);    // 201
        return BadRequest("Invalid data");               // 400
        return NotFound();                               // 404
        return Unauthorized();                           // 401
        return Redirect("/home");                        // 302
    }
}
```

### API Convention Classes
```csharp
// Custom convention
[ApiConventionType(typeof(DefaultApiConventions))]
public class ProductsController : ControllerBase
{
    [ApiConventionMethod(typeof(DefaultApiConventions), 
                         nameof(DefaultApiConventions.Get))]
    public IActionResult GetProduct(int id) => Ok();
}

// Custom convention class
public static class CustomConventions
{
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public static void Get(int id) { }
    
    [ProducesResponseType(StatusCodes.Status201Created)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public static void Post(Product product) { }
}
```

## Probable Interview Questions and Answers

### Basic Level Questions

**Q1: What's the difference between Program.cs and Startup.cs?**
**A:** Startup.cs was used in older versions for service configuration (ConfigureServices) and middleware pipeline (Configure). Program.cs now handles both in .NET 6+ using the minimal API approach, simplifying the bootstrapping process.

**Q2: When should you use ControllerBase vs Controller?**
**A:** Use ControllerBase for Web APIs (no view support) and Controller for MVC applications that return views. Controller inherits from ControllerBase and adds view-related methods.

### Intermediate Level Questions

**Q3: What's the correct order for middleware components and why?**
```csharp
// CORRECT ORDER EXPLANATION:
app.UseExceptionHandler();    // First - catch all exceptions
app.UseHttpsRedirection();    // Early - before any processing
app.UseStaticFiles();         // Before routing - static files don't need routing
app.UseRouting();             // Route matching
app.UseAuthentication();      // Before authorization
app.UseAuthorization();       // Before endpoints
app.UseEndpoints();           // Last - execute endpoints
```
**Reasoning:** Order matters because middleware executes sequentially. Exception handling should be first, security early, and routing before endpoint execution.

**Q4: How does Kestrel differ from IIS as a web server?**
**A:** Kestrel is cross-platform, lightweight, and designed specifically for ASP.NET Core. IIS is Windows-only, feature-rich, but heavier. Kestrel can run behind IIS as a reverse proxy.

### Advanced/Tricky Questions

**Q5: What happens if you put UseRouting after UseEndpoints?**
**A:** Endpoints won't be properly mapped, and routing will not work. The framework might throw an exception or requests will return 404 errors.

**Reasoning:** UseRouting analyzes the request to determine which endpoint to execute, and UseEndpoints actually executes the selected endpoint. They must be in the correct order.

**Q6: How would you create a custom middleware that measures request duration?**
```csharp
public class TimingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<TimingMiddleware> _logger;

    public TimingMiddleware(RequestDelegate next, ILogger<TimingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var stopwatch = Stopwatch.StartNew();
        
        // Call the next middleware
        await _next(context);
        
        stopwatch.Stop();
        _logger.LogInformation($"Request took {stopwatch.ElapsedMilliseconds}ms");
        
        // Add custom header
        context.Response.Headers["X-Processing-Time"] = stopwatch.ElapsedMilliseconds.ToString();
    }
}

// Extension method for easy use
public static class TimingMiddlewareExtensions
{
    public static IApplicationBuilder UseTiming(this IApplicationBuilder app)
    {
        return app.UseMiddleware<TimingMiddleware>();
    }
}
```

**Q7: What's the difference between [FromBody], [FromForm], [FromQuery], and [FromRoute]?**
```csharp
public class ProductsController : ControllerBase
{
    // /api/products/1?details=true
    [HttpGet("{id}")]
    public IActionResult GetProduct(
        [FromRoute] int id,           // From URL route
        [FromQuery] bool details)     // From query string
    {
        return Ok();
    }
    
    [HttpPost]
    public IActionResult CreateProduct(
        [FromBody] Product product)   // From request body (JSON)
    {
        return Created();
    }
    
    [HttpPost("form")]
    public IActionResult CreateFromForm(
        [FromForm] Product product)   // From form data
    {
        return Created();
    }
}
```

**Q8: How do you handle API versioning in ASP.NET Core?**
```csharp
// Using Microsoft.AspNetCore.Mvc.Versioning
builder.Services.AddApiVersioning(options =>
{
    options.DefaultApiVersion = new ApiVersion(1, 0);
    options.AssumeDefaultVersionWhenUnspecified = true;
    options.ReportApiVersions = true;
});

[ApiVersion("1.0")]
[ApiVersion("2.0")]
[Route("api/v{version:apiVersion}/[controller]")]
public class ProductsController : ControllerBase
{
    [MapToApiVersion("1.0")]
    [HttpGet]
    public IActionResult GetV1() => Ok("Version 1");
    
    [MapToApiVersion("2.0")]
    [HttpGet]
    public IActionResult GetV2() => Ok("Version 2");
}
```

### Configuration and Environment Questions

**Q9: How do you manage different configurations for development, staging, and production?**
```csharp
var builder = WebApplication.CreateBuilder(args);

// Environment-specific appsettings
builder.Configuration
    .AddJsonFile("appsettings.json")
    .AddJsonFile($"appsettings.{builder.Environment.EnvironmentName}.json", optional: true);

// Environment-specific services
if (builder.Environment.IsDevelopment())
{
    builder.Services.AddDatabaseDeveloperPageExceptionFilter();
}

// Set environment via:
// - ASPNETCORE_ENVIRONMENT environment variable
// - launchSettings.json
// - Command line: --environment Production
```

**Q10: What's the purpose of launchSettings.json?**
```json
{
  "profiles": {
    "Development": {
      "commandName": "Project",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "Production": {
      "commandName": "Project",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}
```
**A:** launchSettings.json defines different launch profiles with specific environment settings for development time.

### Performance and Optimization Questions

**Q11: How would you optimize middleware performance?**
**A:** 
- Use built-in middleware instead of custom when possible
- Place conditional middleware early to avoid unnecessary processing
- Use `UseWhen` for conditional middleware branches
- Avoid heavy operations in middleware constructors

**Q12: What's the difference between in-process and out-of-process hosting with IIS?**
```xml
<!-- In-process (faster) -->
<aspNetCore processPath="dotnet" hostingModel="inprocess" />

<!-- Out-of-process (more isolation) -->
<aspNetCore processPath="dotnet" hostingModel="outofprocess" />
```
**A:** In-process runs in the IIS worker process (w3wp.exe), offering better performance. Out-of-process runs in a separate dotnet process, providing more isolation.

### Routing Tricky Questions

**Q13: What happens when multiple routes match a request?**
**A:** ASP.NET Core selects the most specific route based on:
1. Route template specificity
2. Order of route registration
3. Constraint matches

**Q14: How do you create a catch-all route?**
```csharp
[Route("api/[controller]")]
public class DocumentsController : ControllerBase
{
    [HttpGet("{*path}")]
    public IActionResult GetDocument(string path)
    {
        // path will capture everything after /api/documents/
        return Ok($"Requested path: {path}");
    }
}
```

This comprehensive guide covers the essential ASP.NET Core application structure concepts that are crucial for a 4-year experience .NET developer interview.
